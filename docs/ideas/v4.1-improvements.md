# v4.1 Improvements

Three improvements: smarter auction pacing, a visible countdown timer, and better employee card visuals.

---

## 1. Auction Debounce Timer

### Problem

The current auction uses a fixed 20-second timeout (`BID_TIMEOUT_MS`) per employee card. This makes auctions feel slow — players wait through the full timer even when no one wants to bid, and the pace doesn't adapt to actual bidding activity.

### Proposed Behavior

Replace the fixed timeout with a **two-tier debounce timer**:

1. When a new employee card is revealed, a **10-second initial timer** starts (time to evaluate the card).
2. If **no one bids** within 10 seconds → the employee is **unsold** (no hire).
3. If **someone bids**, the timer **resets to 5 seconds** (shorter — keep the pace tight).
4. Each subsequent bid resets the timer to 5 seconds again.
5. When 5 seconds pass with **no new bids** → bidding closes and the highest bidder wins.

```
Card revealed ──► 10s idle ──► No bids ──► Unsold
                     │
                  Bid placed ──► Reset 5s ──► Bid placed ──► Reset 5s ──► 5s idle ──► Sold to highest
```

Applies equally to both **auction** and **secondary-hire** phases.

### Changes Required

#### 1a. Constants (`packages/shared/src/constants.ts`)

```ts
// Before
BID_TIMEOUT_MS: 20_000, // 20s per round

// After
BID_INITIAL_TIMEOUT_MS: 10_000, // 10s to evaluate new card
BID_DEBOUNCE_MS: 5_000,         // 5s after each bid
```

#### 1b. Worker Logic (`packages/worker/src/room.ts`)

Split `scheduleAuctionTimeout()` into two paths:

```ts
// Called when a new card is revealed (phase start / next card)
private scheduleAuctionInitialTimeout(): void {
  const multiplier = this.getSpeedMultiplier();
  this.scheduleAlarm(Math.max(10, Math.round(TIMING.BID_INITIAL_TIMEOUT_MS * multiplier)));
}

// Called after every bid (debounce — shorter window)
private scheduleAuctionBidTimeout(): void {
  const multiplier = this.getSpeedMultiplier();
  this.scheduleAlarm(Math.max(10, Math.round(TIMING.BID_DEBOUNCE_MS * multiplier)));
}
```

Call sites:
- `scheduleBotTurnIfNeeded()` for auction/secondary-hire phases → `scheduleAuctionInitialTimeout()`
- `handlePlaceBid()` after a successful bid → `scheduleAuctionBidTimeout()`
- `handleAuctionTimeout()` when a bot bids and resets → `scheduleAuctionBidTimeout()`

The Durable Object alarm is naturally "last write wins" — calling `scheduleAlarm()` overwrites any pending alarm, so this gives us the debounce for free.

#### 1c. Client — No Changes

The client doesn't show a countdown timer, so no client changes are needed for the core behavior. The existing "Current Bid" UI and toast messages already reflect real-time bidding.

#### 1d. Bot Behavior

Bots already work with this flow:
- `scheduleBotBids()` triggers bot counter-bids with random delays (`getBotDelay`).
- If a bot bids, it resets the alarm via `scheduleAuctionTimeout()` in `handleAuctionTimeout`.
- The 10s window gives bots enough time to react (bot delays are 0.8–2.5s at normal speed).

#### 1e. Spectator Mode

Speed multipliers apply to both timers:
- **Normal** (1.0x): 10s initial / 5s debounce
- **Fast** (0.3x): 3s initial / 1.5s debounce
- **Instant** (0.01x): ~10ms both (minimum floor)

### Scope

| File | Change |
|------|--------|
| `packages/shared/src/constants.ts` | Replace `BID_TIMEOUT_MS` with `BID_INITIAL_TIMEOUT_MS` (10s) + `BID_DEBOUNCE_MS` (5s) |
| `packages/worker/src/room.ts` | Split `scheduleAuctionTimeout()` into `scheduleAuctionInitialTimeout()` + `scheduleAuctionBidTimeout()`, update 3 call sites |

**Two files, small diff.**

### Risks

- **5s too fast after a bid?** Players only need to click "Place Bid" and adjust a number — 5s should be enough. The initial 10s gives time to read the card.
- **Bot pile-ons**: Bots already have staggered delays (0.8–2.5s). Each bot bid resets the 5s timer, so contested cards still get proper bidding time organically.

---

## 2. Auction Countdown Timer

### Problem

Players have no visual indication of how much time remains to place a bid. Combined with the debounce timer (feature 1), this is critical — the timer resets silently on each bid, so without a visible countdown, players can't tell if they have 5 seconds or 0.5 seconds left.

### Proposed Behavior

A **countdown bar** displayed near the bid status area that:
- Starts full when a new card is revealed (10s) or a bid resets the timer (5s)
- Drains smoothly to zero
- Changes color as time runs low (green → yellow → red)

```
┌─────────────────────────────┐
│ ████████████░░░░░  7s left  │  ← green
└─────────────────────────────┘

┌─────────────────────────────┐
│ ████░░░░░░░░░░░░░  2s left  │  ← red
└─────────────────────────────┘
```

### Changes Required

#### 2a. New Server Message (`packages/shared/src/types.ts`)

Add a new server→client message to broadcast the timer duration:

```ts
| { type: 'timer-started'; durationMs: number }
```

Sent whenever a timer starts or resets:
- Card revealed → `durationMs: 10000` (or scaled by speed multiplier)
- Bid placed → `durationMs: 5000` (or scaled)

The client uses the received duration to start a local countdown — no need to sync clocks or send a timestamp.

#### 2b. Worker (`packages/worker/src/room.ts`)

Broadcast `timer-started` from the same call sites as the alarm scheduling:
- `scheduleAuctionInitialTimeout()` → broadcast `{ type: 'timer-started', durationMs }`
- `scheduleAuctionBidTimeout()` → broadcast `{ type: 'timer-started', durationMs }`

#### 2c. Client — Countdown Component

Add a `CountdownBar` component:
- Receives `durationMs` from the WebSocket message
- Uses `setInterval` (100ms ticks) to update a progress bar
- Shows remaining seconds as text
- Color transitions: `>50%` green, `20-50%` yellow, `<20%` red

Place it in the `AuctionPhase` component between the `bid-status` div and the `bid-controls` div.

#### 2d. Client — WebSocket Handler

Handle the `timer-started` message in the WebSocket state to update a reactive signal:

```ts
// In client state
const [timerDuration, setTimerDuration] = createSignal<number | null>(null);

// On message
case 'timer-started':
  setTimerDuration(msg.durationMs);
  break;
```

### Scope

| File | Change |
|------|--------|
| `packages/shared/src/types.ts` | Add `timer-started` to `ServerMessage` union |
| `packages/worker/src/room.ts` | Broadcast `timer-started` alongside alarm scheduling |
| `packages/client/src/state/websocket.ts` | Handle `timer-started` message, expose signal |
| `packages/client/src/components/game/phases/AuctionPhase.tsx` | Add `CountdownBar` component |
| `packages/client/src/style.css` | Countdown bar styles |

### Risks

- **Drift**: Local `setInterval` may drift slightly from the server alarm. Acceptable — the bar is a visual hint, not the source of truth. The server alarm is authoritative.
- **Spectator mode at instant speed**: At 0.01x, timers are ~10ms. The bar will flash and disappear instantly, which is fine — spectators aren't bidding.

---

## 3. Employee Card Art

### Problem

Employee cards currently display only text (name, role, category, stats). They all look the same visually, making it hard to distinguish cards at a glance and reducing the "collectible" feel of hiring employees.

### Proposed Solution

Add a **silhouette illustration** to each employee card, unique per employee, reflecting their role and gender.

Each of the 18 main employees + reserve employees gets a distinct silhouette that conveys:
- **Role** — visual props/posture (e.g., laptop for engineers, presentation screen for PMs, handshake for sales)
- **Gender** — inferred from character names (already gendered Indian names in the data)
- **Category color** — silhouette tinted or backed by the category color

### Asset Approach: Image Generation

Generated via image model prompts (not hand-coded SVG). Rationale:
- 20+ unique silhouettes with role-specific props need artistic variety
- Programmatic SVG would be high effort for mediocre results
- The employee deck is static — generate once, bundle as assets

**Asset format:** PNG with transparent background (or SVG if the model supports it), consistent dimensions (~200x300px).

**Storage:** `packages/client/public/employees/{id}.png` — referenced by employee ID.

### Employee Roster (for prompt generation)

| ID | Name | Role | Category | Gender |
|----|------|------|----------|--------|
| 1 | Priya Sharma | Backend Engineer | Engineering | F |
| 2 | Arjun Patel | Frontend Developer | Engineering | M |
| 3 | Kavya Reddy | DevOps Engineer | Engineering | F |
| 4 | Rohan Mehta | Data Engineer | Engineering | M |
| 5 | Ananya Krishnan | Product Manager | Product | F |
| 6 | Vikram Singh | UX Designer | Product | M |
| 7 | Meera Iyer | Product Analyst | Product | F |
| 8 | Aditya Nair | Growth PM | Product | M |
| 9 | Neha Gupta | Sales Lead | Sales | F |
| 10 | Rahul Verma | Account Executive | Sales | M |
| 11 | Shreya Joshi | Business Development | Sales | F |
| 12 | Karthik Rao | Enterprise Sales | Sales | M |
| 13 | Divya Menon | Operations Manager | Ops | F |
| 14 | Amit Kumar | Supply Chain Lead | Ops | M |
| 15 | Pooja Desai | Customer Success | Ops | F |
| 16 | Sanjay Kapoor | Finance Manager | Finance | M |
| 17 | Ritu Agarwal | Financial Analyst | Finance | F |
| 18 | Varun Bhatia | Accounts Lead | Finance | M |
| 19 | Tanvi Shah | Full Stack Developer | Engineering (Reserve) | F |
| 20 | Nikhil Saxena | Head of Sales | Sales (Reserve) | M |

### Client Changes

- Employee card component gains an `<img>` for the silhouette
- Fallback to a generic category-colored placeholder if image fails to load
- No type changes needed — the image is resolved by `employee.id`, not stored in game state

### Scope

| File | Change |
|------|--------|
| `packages/client/public/employees/` | Add generated silhouette assets (20 PNGs) |
| Employee card component (client) | Add `<img>` element with `src=/employees/{id}.png` |

### Risks

- **Asset size**: 20 PNGs at ~10-20KB each = ~200-400KB total. Acceptable.
- **Visual consistency**: All prompts need a shared style directive (same art style, same silhouette treatment, same background) to look cohesive as a set.
