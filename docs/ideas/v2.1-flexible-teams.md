# ESOP Wars v2.1 - Flexible Team Count (2-5 Players, No Bots)

Allow games with 2-5 human players without backfilling empty slots with bots. Card decks and game mechanics scale dynamically based on the number of teams playing.

---

## Problem

Currently, the game is hardcoded for 5 teams. Empty slots are always filled with bots. This creates issues:

1. **2-3 player games feel bot-heavy** - Most teams are bots, which reduces the social element
2. **Auction is too long with few humans** - 18 employee cards auctioned when only 2 teams are hiring makes the phase drag
3. **Can't play a quick 2-player game** - No way to start without 3 bot opponents
4. **Market Leader bonus is meaningless at 2 teams** - "Top 2 gainers" means everyone gets the bonus

---

## Goals

- A host can start a game with 2-5 human players, no bots required
- Card counts and mechanics scale so every team count feels balanced
- Existing 5-player and spectator (all-bot) modes continue to work unchanged

---

## Current Card Inventory

| Deck | Count | Current usage (5 teams) |
|------|-------|------------------------|
| Employees (auction) | 18 | 18 auctioned, up to 15 hired (5 x 3) |
| Employees (reserve) | 3 | Added to secondary pool alongside dropped employees |
| Segments | 18 (3 sets of 6) | 5 dealt initially, rest in draw pile |
| Product ideas | 16 | Combined with service ideas (32 total) |
| Service ideas | 16 | 20 dealt initially (4/team), rest in draw pile |
| Market cards | 6 | 3 drawn (seed, early, mature) |
| Exit cards | 6 | 5 drawn (1/team) |

---

## Scaling Rules

### Employee Deck

The auction is the phase most affected by team count. Too many cards = tedium. Too few = no competition.

**Formula**: `teamCount x 4` employees (shuffled subset from the 18 auction cards)

| Teams | Employees in deck | Max hired | Leftovers | Cards per team ratio |
|-------|-------------------|-----------|-----------|---------------------|
| 2 | 8 | 6 | 2 | 4.0 |
| 3 | 12 | 9 | 3 | 4.0 |
| 4 | 16 | 12 | 4 | 4.0 |
| 5 | 18 (all) | 15 | 3 | 3.6 (unchanged) |

**Category balance**: When subsetting, select proportionally from each category to avoid lopsided auctions. Suggested distribution per team count:

| Teams | Eng | Product | Sales | Ops | Finance |
|-------|-----|---------|-------|-----|---------|
| 2 | 2 | 2 | 2 | 1 | 1 |
| 3 | 3 | 3 | 2 | 2 | 2 |
| 4 | 4 | 4 | 3 | 3 | 2 |
| 5 | 4 | 4 | 4 | 3 | 3 (all cards) |

For 2-4 teams, shuffle each category pool independently, take the required count, then combine and shuffle the final deck.

**Reserve employees (3) are never part of the main auction.** They are always added to the secondary pool alongside dropped employees, regardless of team count.

### Setup Decks (Segments & Ideas)

Less sensitive to team count since each team only draws a few cards.

- **Segments**: Deal 1 per team initially. Keep full deck for draw pile (plenty at 18).
- **Ideas**: Deal 4 per team initially. Keep full deck for draw pile (plenty at 32).
- **No scaling needed** - decks are large enough for any team count.

### Market Cards

- 3 market rounds regardless of team count (seed, early, mature). No change.
- **Market Leader bonus**: Currently top 2 gainers. Scale to `max(1, floor(teamCount / 2))`:

| Teams | Leaders rewarded |
|-------|-----------------|
| 2 | 1 |
| 3 | 1 |
| 4 | 2 |
| 5 | 2 (unchanged) |

### Exit Cards

- 1 drawn per team. Pool of 6 is enough for any count. No change to deck.
- With fewer teams, more variance since the drawn subset is smaller. This is fine - adds excitement.

### Secondary Market

- Each team drops 1 employee. 3 reserve employees are always added to the pool.
- Pool size = `teamCount + 3` cards.

| Teams | Dropped | Reserve | Pool size |
|-------|---------|---------|-----------|
| 2 | 2 | 3 | 5 |
| 3 | 3 | 3 | 6 |
| 4 | 4 | 3 | 7 |
| 5 | 5 | 3 | 8 (unchanged) |

- No scaling needed. Pool is healthy at every team count.

---

## Lobby Changes

### Room Settings

The host gets a new option before starting: **"Fill empty slots with bots?"** (toggle, default: on for backward compat).

When toggled off:
- Game starts with only the human players who have selected teams
- Minimum 2 teams required to start
- The "Start Game" button label changes to "Start Game (N players)"

### Team Selection

With bot-fill disabled:
- Only teams with a human player are included in the game
- Unselected team slots show "Not playing" instead of "Empty"
- The host sees a count: "2 of 5 teams ready"

### Wire Format

Add to `start-game` message:
- `fillBots: boolean` (default `true`)

Add to `RoomState`:
- `fillBots: boolean`

The worker reads `fillBots` when initializing the game and either backfills with bots (current behavior) or creates a game with only the selected teams.

---

## Game Engine Changes

### `GAME.TEAM_COUNT` is no longer fixed

Replace the constant with a dynamic value derived from the room's player count. Key references:

| File | What uses `GAME.TEAM_COUNT` | Change |
|------|----------------------------|--------|
| `constants.ts` | `TEAM_COUNT: 5` | Keep as `MAX_TEAM_COUNT`. Add `MIN_TEAM_COUNT: 2` |
| `game-engine.ts` | `initializeGame()` | Accept `teamCount` parameter, build decks accordingly |
| `game-engine.ts` | `isPhaseComplete()` | Already uses `state.teams.length`, no change |
| `game-engine.ts` | Setup dealing | Already iterates `newState.teams`, no change |
| `room.ts` | Game initialization | Pass actual team count from room |
| `renderer.ts` | Sidebar, team strip | Already iterates `state.gameState.teams`, no change |

### `initializeGame()` Deck Building

```
function buildEmployeeDeck(teamCount: number): EmployeeCard[]
  pool = [...employeeCards]                        // 18 auction cards only
  if teamCount >= 5: return shuffle(pool)          // use all cards at 5 teams

  // Proportional category selection
  for each category:
    available = pool.filter(category)
    take = distribution[teamCount][category]
    selected.push(shuffle(available).slice(0, take))

  return shuffle(selected.flat())
```

Reserve employees continue to be added to the secondary pool via `populateSecondaryPool()` unchanged.

### Market Leader Count

```
function getMarketLeaderCount(teamCount: number): number
  return Math.max(1, Math.floor(teamCount / 2))
```

Currently the market leader logic lives in `applyMarketCard()`. Update it to use this function instead of a hardcoded 2.

---

## What Doesn't Change

- ESOP per team (12%) - same regardless of team count
- Initial valuation (20M) - same
- Employees per team (3) - same
- Setup rounds (3) - same
- Market rounds (3) - same
- Wildcard mechanics - same
- Exit mechanics - same
- Spectator/bot-only mode - unchanged (always uses 5 teams)
- Bid timeout - same

---

## Open Questions

1. **Secondary market with 2 teams**: Each drops 1, so 2 cards in pool. Worth keeping? Or skip secondary for 2-team games?
2. **Should bot-fill be the default?** Current behavior (bots fill) is well-tested. New behavior (no bots) could be opt-in or eventually become the default.
3. **Employee deck**: Is `teamCount x 4` the right ratio? Playtest needed. Could also do `teamCount x 3 + 2` for a tighter auction.
4. **Minimum players**: Should we allow 1-player (vs bots only)? Or keep minimum at 2 humans?
